<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doubao API 管理后台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-idle { background-color: #28a745; box-shadow: 0 0 8px #28a745; }
        .status-busy { background-color: #dc3545; box-shadow: 0 0 8px #dc3545; }
        .status-cooldown { background-color: #ffc107; box-shadow: 0 0 8px #ffc107; }
        .token-text { font-family: monospace; color: #6c757d; font-size: 0.85em; }
        .stats-val { font-size: 1.8rem; font-weight: bold; }
        .progress { height: 8px; border-radius: 4px; }
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" class="container py-4" v-cloak>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-robot me-2"></i>Doubao API 管理</h2>
        <div>
            <button @click="resetAllUsage" class="btn btn-outline-danger btn-sm me-2">
                <i class="bi bi-arrow-counterclockwise"></i> 重置所有今日统计
            </button>
            <button @click="fetchData" class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-repeat"></i> 刷新数据
            </button>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="row text-center">
        <div class="col-md-3">
            <div class="card p-3">
                <div class="text-muted small mb-1">活跃账号 / 总数</div>
                <div class="stats-val">{{ stats.enabledAccounts }} / {{ stats.totalAccounts }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3">
                <div class="text-muted small mb-1">状态 (空闲/忙碌/冷却)</div>
                <div class="d-flex justify-content-center align-items-center stats-val">
                    <span class="text-success">{{ stats.statusCounts.idle }}</span>
                    <span class="mx-2 text-muted">/</span>
                    <span class="text-danger">{{ stats.statusCounts.busy }}</span>
                    <span class="mx-2 text-muted">/</span>
                    <span class="text-warning">{{ stats.statusCounts.cooldown }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3">
                <div class="text-muted small mb-1">当前队列</div>
                <div class="stats-val text-primary">{{ stats.queue.current }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3">
                <div class="text-muted small mb-1">今日总剩余可用</div>
                <div class="stats-val text-info">{{ stats.totalRemaining }}</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 账号列表 -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">账号池管理</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>状态</th>
                                <th>备注名称</th>
                                <th>今日使用情况</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="acc in accounts" :key="acc.id">
                                <td>
                                    <span :class="['status-dot', 'status-' + acc.status]" :title="acc.status"></span>
                                    <small class="text-capitalize">{{ acc.status }}</small>
                                </td>
                                <td>
                                    <div class="fw-bold">{{ acc.name }}</div>
                                    <div class="token-text">{{ acc.token.substring(0, 10) }}...{{ acc.token.slice(-5) }}</div>
                                </td>
                                <td style="width: 200px;">
                                    <div class="d-flex justify-content-between mb-1 small">
                                        <span>{{ acc.dailyUsage }} / {{ acc.dailyLimit }}</span>
                                        <span class="text-muted">余 {{ acc.remaining }}</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" 
                                             :class="acc.dailyUsage >= acc.dailyLimit ? 'bg-danger' : 'bg-success'"
                                             :style="{width: (acc.dailyUsage / acc.dailyLimit * 100) + '%'}"></div>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button @click="editAccount(acc)" class="btn btn-outline-primary btn-sm" title="编辑">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button @click="toggleAccount(acc)" class="btn btn-sm" :class="acc.enabled ? 'btn-outline-warning' : 'btn-outline-success'" :title="acc.enabled ? '点击禁用' : '点击启用'">
                                            <i class="bi" :class="acc.enabled ? 'bi-pause-fill' : 'bi-play-fill'"></i>
                                        </button>
                                        <button @click="resetAccount(acc.id)" class="btn btn-outline-secondary btn-sm" title="重置今日计数">
                                            <i class="bi bi-eraser"></i>
                                        </button>
                                        <button @click="deleteAccount(acc.id)" class="btn btn-outline-danger btn-sm" title="删除账号">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr v-if="accounts.length === 0">
                                <td colspan="4" class="text-center py-4 text-muted">暂无账号，请在右侧添加</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 添加账号 & 设置 -->
        <div class="col-lg-4">
            <div class="card p-3">
                <h5 class="mb-3">{{ editingId ? '编辑账号' : '添加新账号' }}</h5>
                <div class="mb-3">
                    <label class="form-label small">SessionID (Refresh Token)</label>
                    <textarea v-model="newAcc.token" class="form-control form-control-sm" rows="3" placeholder="粘贴 sessionid"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label small">备注名</label>
                    <input v-model="newAcc.name" type="text" class="form-control form-control-sm" placeholder="如：账号1">
                </div>
                <div class="mb-3">
                    <label class="form-label small">每日限制次数</label>
                    <input v-model.number="newAcc.dailyLimit" type="number" class="form-control form-control-sm">
                </div>
                <div class="d-flex gap-2">
                    <button @click="submitAccount" class="btn w-100 btn-sm" :class="editingId ? 'btn-primary' : 'btn-success'">
                        <i class="bi" :class="editingId ? 'bi-save' : 'bi-plus-circle'"></i> {{ editingId ? '保存修改' : '立即添加' }}
                    </button>
                    <button v-if="editingId" @click="cancelEdit" class="btn btn-outline-secondary w-50 btn-sm">
                        取消
                    </button>
                </div>
            </div>

            <div class="card p-3">
                <h5 class="mb-3">全局设置</h5>
                <div class="mb-3">
                    <label class="form-label small">冷却时间 (毫秒)</label>
                    <div class="input-group input-group-sm">
                        <input v-model.number="settings.cooldownTime" type="number" class="form-control">
                        <span class="input-group-text">ms</span>
                    </div>
                    <div class="form-text small">单账号请求完成后，该账号强制休息的时长。</div>
                </div>
                <button @click="saveSettings" class="btn btn-primary w-100 btn-sm">保存设置</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
<script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            const accounts = ref([]);
            const stats = ref({
                totalAccounts: 0, enabledAccounts: 0, 
                statusCounts: { idle: 0, busy: 0, cooldown: 0 },
                queue: { current: 0, limit: 0 },
                totalRemaining: 0
            });
            const settings = ref({ cooldownTime: 10000 });
            const newAcc = ref({ token: '', name: '', dailyLimit: 100 });
            const editingId = ref(null);

            const fetchData = async () => {
                try {
                    const [accRes, statsRes, setRes] = await Promise.all([
                        fetch('/admin/accounts').then(r => r.json()),
                        fetch('/admin/stats').then(r => r.json()),
                        fetch('/admin/settings').then(r => r.json())
                    ]);
                    accounts.value = accRes.data;
                    stats.value = statsRes.data;
                    settings.value = setRes.data;
                } catch (e) {
                    console.error("Failed to fetch data", e);
                }
            };

            const submitAccount = async () => {
                if (!newAcc.value.token) return alert("Token 不能为空");
                
                try {
                    let url = '/admin/accounts';
                    // 如果是编辑模式，修改 URL
                    if (editingId.value) {
                        url = `/admin/accounts/${editingId.value}`;
                    }

                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newAcc.value)
                    });

                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.msg || "操作失败");
                    }

                    cancelEdit(); // 重置表单
                    fetchData();
                    // alert(editingId.value ? "修改成功！" : "添加成功！");
                } catch (e) {
                    alert("操作失败: " + e.message);
                }
            };

            const editAccount = (acc) => {
                editingId.value = acc.id;
                newAcc.value = { 
                    token: acc.token, 
                    name: acc.name, 
                    dailyLimit: acc.dailyLimit 
                };
            };

            const cancelEdit = () => {
                editingId.value = null;
                newAcc.value = { token: '', name: '', dailyLimit: 100 };
            };

            const toggleAccount = async (acc) => {
                await fetch(`/admin/accounts/${acc.id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !acc.enabled })
                });
                fetchData();
            };

            const resetAccount = async (id) => {
                await fetch(`/admin/accounts/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dailyUsage: 0 })
                });
                fetchData();
            };

            const deleteAccount = async (id) => {
                if (!confirm("确定删除该账号吗？")) return;
                await fetch(`/admin/accounts/${id}`, { method: 'DELETE' });
                fetchData();
            };

            const saveSettings = async () => {
                await fetch('/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings.value)
                });
                alert("设置已保存");
                fetchData();
            };

            const resetAllUsage = async () => {
                if (!confirm("确定重置所有账号的今日使用统计吗？")) return;
                await fetch('/admin/reset-all', { method: 'POST' });
                fetchData();
            };

            onMounted(() => {
                fetchData();
                setInterval(fetchData, 3000); // 每3秒自动刷新一次
            });

            return { accounts, stats, settings, newAcc, editingId, fetchData, submitAccount, editAccount, cancelEdit, toggleAccount, resetAccount, deleteAccount, saveSettings, resetAllUsage };
        }
    }).mount('#app');
</script>
</body>
</html>
